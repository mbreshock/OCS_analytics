---
title: "GA_analysis"
author: "Michael Breshock"
date: "6/25/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(googleAnalyticsR)
library(ggplot2)
library(tidyverse)
library(magrittr)
```

```{r}
theme_set(theme_linedraw() + 
            theme(axis.text = element_text(size = 11, 
                                           color = "black"),
                  axis.title = element_text(size = 12, 
                                            color = "black"),
                  plot.title = element_text(hjust = .5))
          )
```

```{r}
ocs_property_id = 256923228
ses_wk_ctg = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("deviceCategory"))
ses_wk_ctg %<>% mutate(percent = round(100*sessions/sum(sessions), 2),
                       total = sum(sessions)) 

ggplot(ses_wk_ctg, aes(x = as.factor(deviceCategory), y = sessions)) +
  geom_bar(stat = "identity")
```
[Paramaters:](https://developers.google.com/analytics/devguides/reporting/data/v1/api-schema)

sessions: The number of sessions that began on your site or app (event triggered: session_start).

deviceCategory: The type of device: Desktop, Tablet, or Mobile.


```{r}
user_sources = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("newUsers"),
          dimensions = c("firstUserSource")) %>%
  subset(grepl("127",firstUserSource) == FALSE) %>% 
  mutate(firstUserSource = as_factor(firstUserSource),
         firstUserSource = fct_infreq(firstUserSource))

ggplot(user_sources, aes(x = firstUserSource, y = newUsers)) +
  geom_bar(stat = "identity") +   theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5))
```
(t.co = twitter)

firstUserSource = The source that first acquired the user to your website or app.

newUsers: The number of users who interacted with your site or launched your app for the first time (event triggered: first_open or first_visit).


```{r}
users_wk = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("totalUsers", "newUsers", "eventCount",
                      "active7DayUsers", "userEngagementDuration"),
          dimensions = c("week")) %>% 
  mutate(week = as.numeric(week),
         avgEngagementDuration = # avg engagement in minutes
           round(userEngagementDuration/(60*totalUsers)))

pivot_longer(users_wk, c(totalUsers, newUsers, active7DayUsers), 
             names_to = "metric", values_to = "count") %>%
  ggplot(aes(x = week, y = count)) +
  geom_line(aes(color = metric))
```

```{r}
users_date = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("totalUsers", "newUsers", "eventCount",
                      "active1DayUsers", "userEngagementDuration"),
          dimensions = c("date"), limit = 1000) %>% 
  mutate(
         avgEngagementDuration = # avg engagement in minutes
           round(userEngagementDuration/(60*active1DayUsers))) %>%
  pivot_longer(c(newUsers, active1DayUsers), 
              names_to = "metric", values_to = "count")

  ggplot(users_date, aes(x = date, y = count, color = metric)) +
    geom_line() + #scale_color_viridis_d() + 
    labs(x = "Day", y = "User Count", title = "Open Case Studies Daily New and Active Users")
```

```{r}
ggplot(users_date, aes(x = as.factor(avgEngagementDuration), 
                       fill = as.factor(avgEngagementDuration))) + 
  geom_bar() + scale_fill_viridis_d() + guides(fill = "none") +
  labs(x = "Average Engagement Duration (Minutes)", y = "Number of Days", 
       title = "Count of Daily Average Engagement") 
```


week: The week of the event, a two-digit number from 01 to 53. Each week starts on Sunday. January 1st is always in week 01. The first and last week of the year have fewer than 7 days in most years. Weeks other than the first and the last week of the year always have 7 days. For years where January 1st is a Sunday, the first week of that year and the last week of the prior year have 7 days.

totalUsers: The number of distinct users who have logged at least one event, regardless of whether the site or app was in use when that event was logged.

eventCount: The count of events.

active7DayUsers: The number of distinct active users on your site or app within a 7 day period. The 7 day period includes the last day in the report's date range.

userEngagementDuration: The total amount of time (in seconds) your website or app was in the foreground of users' devices. 


```{r}
cities = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("country", "city"), limit = 1000)
cities
```

city: The city from which the user activity originated.

```{r, browser}
ocs_property_id = 256923228
browsers = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("browser"))
head(browsers)
```

```{r, dhm}
ocs_property_id = 256923228
dhm = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("hour"), limit = 1000)
dhm
```

```{r, mediums}
ocs_property_id = 256923228
mediums = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("medium"))
mediums
```

```{r, url}
ocs_property_id = 256923228
urls = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("fullPageUrl"))
urls
```

```{r, langauge}
ocs_property_id = 256923228
language = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("newUsers"),
          dimensions = c("language"))
language
```

```{r, linkUrl}
ocs_property_id = 256923228
linkUrl = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("linkUrl"))
linkUrl
```

```{r, OSversion}
ocs_property_id = 256923228
OSversion = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("operatingSystem"))
OSversion
```

```{r, pageReferrer}
ocs_property_id = 256923228
pageReferrer = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("pageReferrer"))
pageReferrer
```


look into collapsing duplicates functions / group_by!
```{r, pagetitle}
ocs_property_id = 256923228
pagetitle = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("pageTitle"))
case_studies = c("School Shootings in the United States", 
                 "Disparities in Youth Disconnection",
                 "Opioids in United States",
                 "Vaping Behaviors in American Youth",
                 "Mental Health of American Youth", 
                 "Exploring global patterns of obesity across rural and urban regions",  "Influence of Multicollinearity on Measured Impact of Right-to-Carry Gun Laws", 
                 "Exploring CO2 emissions across time",
                 "Influence of Multicollinearity on Measured Impact of Right-to-Carry Gun Laws Part 1", 
                 "Exploring global patterns of dietary behaviors associated with health risk",
                 "Predicting Annual Air Pollution")
pages = pagetitle %>% mutate(
  ocs = str_remove(pageTitle, pattern = "Open Case Studies: ") 
) %>% 
  filter(ocs %in% case_studies) %>% 
  mutate(
    static = str_count(pageTitle, "Open Case Studies: ")) %>%
  mutate(
    code = case_when(
      ocs == "School Shootings in the United States" ~ "School Shootings", 
      ocs == "Disparities in Youth Disconnection" ~ "Youth Disconnection", 
      ocs == "Opioids in United States" ~ "Opiods",
      ocs == "Vaping Behaviors in American Youth" ~ "Vaping",
      ocs == "Mental Health of American Youth" ~ "Mental Health",
      ocs == "Exploring global patterns of obesity across rural and urban regions" ~ "Obesity", 
      ocs == "Influence of Multicollinearity on Measured Impact of Right-to-Carry Gun Laws" ~ "RTC Analysis",
      ocs == "Exploring CO2 emissions across time" ~ "CO2 Emissions",
      ocs == "Influence of Multicollinearity on Measured Impact of Right-to-Carry Gun Laws Part 1" ~ "RTC Wrangling",
      ocs == "Exploring global patterns of dietary behaviors associated with health risk" ~ "Diet",
      ocs == "Predicting Annual Air Pollution" ~ "Air Pollution"
    )
  ) %>% group_by(code) %>% 
  mutate(ocs_sum = sum(sessions)) %>% select(code, ocs_sum) %>% distinct()
pages
```

```{r, percentScrolled}
ocs_property_id = 256923228
percentScrolled = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("percentScrolled"))
percentScrolled
```

```{r, searchTerm}
ocs_property_id = 256923228
searchTerm = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("searchTerm"))
searchTerm
```

```{r, sources}
ocs_property_id = 256923228
sources = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessions"),
          dimensions = c("source"))
sources
```

```{r, engagedSessions}
ocs_property_id = 256923228
engagedSessions = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("engagedSessions", "engagementRate"),
          dimensions = c("date"), limit = 1000)
engagedSessions
```

```{r, screenPageViews}
ocs_property_id = 256923228
screenPageViews = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("screenPageViews"),
          dimensions = c("pageTitle"), limit = 1000)
screenPageViews
```

```{r, sessionsPerUser}
ocs_property_id = 256923228
sessionsPerUser = ga_data(ocs_property_id,
          date_range = c("2021-01-01", "yesterday"),
          metrics = c("sessionsPerUser"),
          dimensions = c("pageTitle"), limit = 1000)
sessionsPerUser
```

dimensions of interest:
- browser
- cohort
- country/countryID
- dateHourMinute
- firstSessionDate
- fileName
- firstUserMedium 
- firstUserTrafficOrigin
- fullPageUrl
- hour, minute
- language, languageCode
- linkClasses, linkDomain, linkUrl
- medium, method
- operatingSystem, operatingSystemWithVersion
- pageLocation, pageReferrer
- pageTitle
- percentScrolled
- searchTerm
- streamName
- sessionSource, source, sessionMedium

metrics of interest: 
- active1DayUsers
- conversions
- engagedSessions, engagementRate
- screenPageViews
- sessions, sessionsPerUser

for users data: use active1Dayusers and newUsers

 
cool figure to make: # of events (or users) per day (events y axis, days x axis)
have a timeline of project development along the x-axis to view if website traffic was changed at all by project developments. 


helpful links: 
https://www.dase-analytics.com/blog/en/how-to-get-data-from-google-analytics-using-r-programming/

https://ga-dev-tools.web.app/dimensions-metrics-explorer/
